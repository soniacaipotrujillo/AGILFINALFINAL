<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Inteligente de Deudas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .welcome { font-size: 28px; font-weight: 700; color: #333; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; }
        .main-content { display: grid; grid-template-columns: 300px 1fr; gap: 25px; }
        .sidebar { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); height: fit-content; }
        .dashboard { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; transition: all 0.3s; color: #555; font-weight: 500; }
        .nav-item:hover { background: #f3f4f6; }
        .nav-item.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05); color: white; }
        .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.pending { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-card.overdue { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .stat-card.paid { background: linear-gradient(135deg, #10b981 0%, #047857 100%); }
        .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 10px; }
        .debt-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .debt-card { background: white; border-radius: 15px; padding: 25px; border: 2px solid #e5e7eb; transition: all 0.3s; position: relative; }
        .debt-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); }
        .debt-card.due-today { border-color: #ef4444; background: linear-gradient(135deg, #fff5f5 0%, #fee 100%); }
        .debt-card.due-week { border-color: #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }
        .debt-card.paid { border-color: #10b981; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); }
        .debt-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; }
        .debt-info h3 { font-size: 20px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .debt-amount { font-size: 24px; font-weight: 700; color: #333; }
        .debt-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .detail-value { font-size: 16px; font-weight: 600; color: #333; }
        .due-date { padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: 500; display: inline-block; margin-top: 10px; }
        .due-date.due-today { background: #ef4444; color: white; }
        .due-date.due-week { background: #f59e0b; color: white; }
        .due-date.normal { background: #e5e7eb; color: #666; }
        .due-date.paid { background: #10b981; color: white; }
        .payment-methods { display: flex; gap: 10px; margin-top: 20px; }
        .payment-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 500; cursor: pointer; color: white; transition: transform 0.2s; }
        .payment-btn.credit { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; border-radius: 20px; padding: 40px; width: 90%; max-width: 500px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; }
        .hidden { display: none !important; }
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Realizar Pago</h3>
                <div onclick="closeModal()" style="cursor:pointer; font-size:24px;">×</div>
            </div>
            <form id="paymentForm" onsubmit="return false;">
                <input type="hidden" id="payDebtId">
                <div class="form-group"><label class="form-label">Monto (S/)</label><input type="number" step="0.01" class="form-input" id="payAmount" required></div>
                <div class="form-group"><label class="form-label">Fecha</label><input type="date" class="form-input" id="payDate" required></div>
                <button class="payment-btn credit" onclick="submitPayment()">Confirmar Pago</button>
            </form>
        </div>
    </div>

    <div id="addDebtModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Nueva Deuda</h3>
                <div onclick="closeModal()" style="cursor:pointer; font-size:24px;">×</div>
            </div>
            <form onsubmit="saveDebt(event)">
                <div class="form-group">
                    <label class="form-label">Banco</label>
                    <select class="form-input" id="bankName" required>
                        <option value="BCP">BCP</option><option value="BBVA">BBVA</option><option value="Interbank">Interbank</option>
                        <option value="Scotiabank">Scotiabank</option><option value="Banco de la Nación">Banco de la Nación</option><option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group"><label class="form-label">Descripción</label><input type="text" class="form-input" id="debtDescription" required></div>
                <div class="form-group"><label class="form-label">Monto (S/)</label><input type="number" step="0.01" class="form-input" id="debtAmount" required></div>
                <div class="form-group"><label class="form-label">Vencimiento</label><input type="date" class="form-input" id="dueDate" required></div>
                <div class="form-group">
                    <label class="form-label">Frecuencia</label>
                    <select class="form-input" id="paymentFrequency">
                        <option value="mensual">Mensual</option><option value="quincenal">Quincenal</option><option value="unico">Único</option>
                    </select>
                </div>
                <button type="submit" class="payment-btn credit">Guardar</button>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="welcome">Gestor de Deudas</div>
            <div class="user-info">
                <div class="user-avatar">U</div>
                <button onclick="api.logout()" style="border:none; background:none; cursor:pointer;">Salir</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="nav-item active" onclick="filterDebts('all')"><i class="fas fa-home"></i> Dashboard</div>
                <div class="nav-item" onclick="filterDebts('pending')"><i class="fas fa-clock"></i> Pendientes</div>
                <div class="nav-item" onclick="filterDebts('overdue')"><i class="fas fa-exclamation-triangle"></i> Vencidas</div>
                <div class="nav-item" onclick="document.getElementById('addDebtModal').classList.add('active')"><i class="fas fa-plus-circle"></i> Agregar</div>
            </div>

            <div class="dashboard">
                <div class="stats-cards">
                    <div class="stat-card total"><h3>Total</h3><div class="stat-value" id="totalDebt">S/ 0.00</div></div>
                    <div class="stat-card pending"><h3>Pendientes</h3><div class="stat-value" id="pendingDebt">S/ 0.00</div></div>
                    <div class="stat-card overdue"><h3>Vencidas</h3><div class="stat-value" id="overdueDebt">S/ 0.00</div></div>
                    <div class="stat-card paid"><h3>Pagadas</h3><div class="stat-value" id="paidDebt">S/ 0.00</div></div>
                </div>
                <div id="debtList" class="debt-cards"></div>
            </div>
        </div>
    </div>

    <script src="frontend_api_integration.js"></script>
    <script>
        let allDebts = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!window.api || !api.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            const user = api.getCurrentUser();
            if(user) document.querySelector('.welcome').textContent = `Hola, ${user.name}!`;
            
            await loadData();
        });

        async function loadData() {
            try {
                // Estadísticas
                const stats = await api.getStatistics();
                document.getElementById('totalDebt').textContent = formatMoney(stats.total_amount);
                document.getElementById('pendingDebt').textContent = formatMoney(stats.pending_amount);
                document.getElementById('overdueDebt').textContent = formatMoney(stats.overdue_amount);
                document.getElementById('paidDebt').textContent = formatMoney(stats.paid_amount);

                // Deudas (Mapeo correcto de datos del backend)
                const debtsData = await api.getAllDebts();
                allDebts = debtsData.map(d => ({
                    id: d.id,
                    bank: d.bank_name,       // Backend: bank_name
                    description: d.description,
                    amount: Number(d.amount),
                    paid: Number(d.paid_amount), // Backend: paid_amount
                    remaining: Number(d.amount) - Number(d.paid_amount),
                    date: d.due_date,        // Backend: due_date
                    status: d.status,
                    urgency: d.urgency       // Backend: urgency
                }));
                renderDebts(allDebts);
            } catch (error) {
                console.error("Error:", error);
            }
        }

        function renderDebts(debts) {
            const container = document.getElementById('debtList');
            container.innerHTML = '';
            
            if (debts.length === 0) {
                container.innerHTML = '<p style="grid-column:1/-1; text-align:center;">No hay deudas registradas.</p>';
                return;
            }

            debts.forEach(d => {
                let cardClass = 'debt-card';
                if (d.status === 'paid') cardClass += ' paid';
                else if (d.urgency === 'overdue') cardClass += ' due-today'; // Rojo para vencidas
                else if (d.urgency === 'due_soon') cardClass += ' due-week'; // Amarillo para próximas

                container.innerHTML += `
                    <div class="${cardClass}">
                        <div class="debt-header">
                            <div class="debt-info"><h3>${d.description}</h3><small>${d.bank}</small></div>
                            <div class="debt-amount">${formatMoney(d.remaining)}</div>
                        </div>
                        <div class="debt-details">
                            <div class="detail-item"><small>Total</small><b>${formatMoney(d.amount)}</b></div>
                            <div class="detail-item"><small>Estado</small><b>${d.status}</b></div>
                        </div>
                        <div class="due-date ${d.status === 'paid' ? 'paid' : (d.urgency === 'overdue' ? 'due-today' : 'normal')}">
                            Vence: ${d.date ? d.date.split('T')[0] : 'N/A'}
                        </div>
                        ${d.status !== 'paid' ? `<div class="payment-methods"><button class="payment-btn credit" onclick="openPayModal(${d.id})">Pagar</button></div>` : ''}
                    </div>
                `;
            });
        }

        async function saveDebt(e) {
            e.preventDefault();
            try {
                await api.createDebt({
                    bank_name: document.getElementById('bankName').value,
                    description: document.getElementById('debtDescription').value,
                    amount: document.getElementById('debtAmount').value,
                    due_date: document.getElementById('dueDate').value,
                    frequency: document.getElementById('paymentFrequency').value
                });
                closeModal();
                await loadData();
            } catch(err) { alert(err.message); }
        }

        async function submitPayment() {
            try {
                await api.createPayment({
                    debt_id: document.getElementById('payDebtId').value,
                    amount: document.getElementById('payAmount').value,
                    payment_date: document.getElementById('payDate').value
                });
                closeModal();
                await loadData();
            } catch(err) { alert(err.message); }
        }

        function formatMoney(n) { return `S/ ${Number(n || 0).toLocaleString('es-PE', {minimumFractionDigits: 2})}`; }
        function closeModal() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }
        function openPayModal(id) {
            document.getElementById('payDebtId').value = id;
            document.getElementById('payDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('paymentModal').classList.add('active');
        }
        function filterDebts(type) {
            if (type === 'all') renderDebts(allDebts);
            else renderDebts(allDebts.filter(d => d.status === type || d.urgency === type));
        }
    </script>
</body>
</html>