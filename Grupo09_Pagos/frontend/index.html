<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor Inteligente de Deudas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ESTILOS (Id√©nticos a tu dise√±o original) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* HEADER */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 20px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .welcome { font-size: 28px; font-weight: 700; color: #333; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; }

        /* LAYOUT */
        .main-content { display: grid; grid-template-columns: 300px 1fr; gap: 25px; }
        .sidebar { background: white; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); height: fit-content; }
        .dashboard { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }

        /* NAVIGATION */
        .nav-item { display: flex; align-items: center; gap: 15px; padding: 15px; margin-bottom: 10px; border-radius: 12px; cursor: pointer; transition: all 0.3s; color: #555; font-weight: 500; }
        .nav-item:hover { background: #f3f4f6; }
        .nav-item.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .nav-item i { font-size: 20px; width: 24px; text-align: center; }

        /* STATS CARDS */
        .stats-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .stat-card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05); color: white; }
        .stat-card h3 { font-size: 16px; margin-bottom: 15px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.9; }
        .stat-card.total { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.pending { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .stat-card.overdue { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .stat-card.paid { background: linear-gradient(135deg, #10b981 0%, #047857 100%); }
        .stat-value { font-size: 32px; font-weight: 700; margin-bottom: 10px; }

        /* DEBT CARDS */
        .debt-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .debt-card { background: white; border-radius: 15px; padding: 25px; border: 2px solid #e5e7eb; transition: all 0.3s; position: relative; }
        .debt-card:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1); }
        .debt-card.due-today { border-color: #ef4444; background: linear-gradient(135deg, #fff5f5 0%, #fee 100%); }
        .debt-card.due-week { border-color: #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); }
        .debt-card.paid { border-color: #10b981; background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%); }
        
        .debt-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px; }
        .debt-info h3 { font-size: 20px; font-weight: 700; color: #333; margin-bottom: 5px; }
        .debt-bank { color: #666; font-size: 14px; display: flex; align-items: center; gap: 5px; }
        .debt-amount { font-size: 24px; font-weight: 700; color: #333; }
        
        .debt-details { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .detail-item { display: flex; flex-direction: column; }
        .detail-label { color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 5px; }
        .detail-value { font-size: 16px; font-weight: 600; color: #333; }

        .due-date { padding: 8px 15px; border-radius: 20px; font-size: 14px; font-weight: 500; display: inline-block; margin-top: 10px; }
        .due-date.due-today { background: #ef4444; color: white; }
        .due-date.due-week { background: #f59e0b; color: white; }
        .due-date.normal { background: #e5e7eb; color: #666; }
        .due-date.paid { background: #10b981; color: white; }

        .payment-methods { display: flex; gap: 10px; margin-top: 20px; }
        .payment-btn { flex: 1; padding: 12px; border: none; border-radius: 10px; font-weight: 500; cursor: pointer; color: white; transition: transform 0.2s; }
        .payment-btn.credit { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); }
        
        /* MODALS */
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7) !important;
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
            backdrop-filter: blur(3px);
        }
        .modal.active { display: flex !important; }
        
        .modal-content { 
            background: #ffffff !important;
            opacity: 1 !important;
            border-radius: 20px; 
            padding: 40px; 
            width: 90%; 
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1001;
        }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; color: #555; font-weight: 500; }
        .form-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 10px; background: white; }
        .hidden { display: none !important; }
        
        @media (max-width: 1024px) { .main-content { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Realizar Pago</h3>
                <div onclick="closeModal()" style="cursor:pointer; font-size:24px;">√ó</div>
            </div>
            <form id="paymentForm" onsubmit="return false;">
                <input type="hidden" id="payDebtId">
                <div class="form-group">
                    <label class="form-label">Monto a Pagar (S/)</label>
                    <input type="number" step="0.01" class="form-input" id="payAmount" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Fecha de Pago</label>
                    <input type="date" class="form-input" id="payDate" required>
                </div>

                <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                <h4 style="margin-bottom: 15px; color: #333;">Datos de la Tarjeta</h4>
                
                <div class="form-group">
                    <label class="form-label">N√∫mero de Tarjeta</label>
                    <input type="text" class="form-input" id="cardNumber" placeholder="4000 1234 5678 9010" maxlength="19">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label class="form-label">Vencimiento (MM/YY)</label>
                        <input type="month" class="form-input" id="cardExp">
                    </div>
                    <div class="form-group">
                        <label class="form-label">CVV</label>
                        <input type="password" class="form-input" id="cardCvv" placeholder="123" maxlength="3">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="font-size: 12px; color: #666;">
                        <i class="fas fa-lock"></i> Pagos procesados de forma segura por MockBank Inc.
                    </label>
                </div>

                <button class="payment-btn credit" onclick="submitPayment()">
                    <i class="fas fa-credit-card"></i> Pagar Ahora
                </button>
            </form>
        </div>
    </div>

    <div id="addDebtModal" class="modal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h3>Nueva Deuda</h3>
                <div onclick="closeModal()" style="cursor:pointer; font-size:24px;">√ó</div>
            </div>
            <form onsubmit="saveDebt(event)">
                <div class="form-group">
                    <label class="form-label">Banco / Entidad</label>
                    <select class="form-input" id="bankName" required>
                        <option value="BCP">BCP</option>
                        <option value="BBVA">BBVA</option>
                        <option value="Interbank">Interbank</option>
                        <option value="Scotiabank">Scotiabank</option>
                        <option value="Banco de la Naci√≥n">Banco de la Naci√≥n</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Descripci√≥n</label>
                    <input type="text" class="form-input" id="debtDescription" placeholder="Ej: Pr√©stamo Personal" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Monto de la Cuota (S/)</label>
                    <input type="number" step="0.01" class="form-input" id="debtAmount" placeholder="Monto por mes" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Frecuencia de Pago</label>
                    <select class="form-input" id="paymentFrequency" onchange="toggleInstallments()">
                        <option value="unico">Pago √önico (Una sola vez)</option>
                        <option value="mensual">Mensual (Cada mes)</option>
                        <option value="quincenal">Quincenal (Cada 15 d√≠as)</option>
                    </select>
                </div>

                <div class="form-group" id="installmentsGroup" style="display: none;">
                    <label class="form-label">¬øCu√°ntas cuotas son?</label>
                    <input type="number" class="form-input" id="installments" min="2" max="60" value="12" placeholder="Ej: 12 meses">
                </div>

                <div class="form-group">
                    <label class="form-label">Fecha de Inicio (1ra Cuota)</label>
                    <input type="date" class="form-input" id="dueDate" required>
                </div>
                
                <button type="submit" class="payment-btn credit">Generar Cronograma</button>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="welcome">Cargando...</div>
            <div class="user-info">
                <div class="user-avatar">U</div>
                <button onclick="window.api.logout()" style="border:none; background:none; cursor:pointer; font-weight: bold; margin-left:10px;">Salir</button>
            </div>
        </div>

        <div class="main-content">
            <div class="sidebar">
                <div class="nav-item active" data-filter="all" onclick="filterDebts('all', event)">
                    <i class="fas fa-home"></i> <span>Dashboard</span>
                </div>
                <div class="nav-item" data-filter="pending" onclick="filterDebts('pending', event)">
                    <i class="fas fa-clock"></i> <span>Pendientes</span>
                    <span class="status-badge status-pending" id="pendingCountBadge" style="margin-left:auto; background:#fef3c7; color:#d97706; padding:2px 8px; border-radius:10px; font-size:12px; display:none;">0</span>
                </div>
                <div class="nav-item" data-filter="overdue" onclick="filterDebts('overdue', event)">
                    <i class="fas fa-exclamation-triangle"></i> <span>Vencidas</span>
                    <span class="status-badge status-overdue" id="overdueCount" style="margin-left:auto; background:#fee2e2; color:#dc2626; padding:2px 8px; border-radius:10px; font-size:12px;">0</span>
                </div>
                <div class="nav-item" onclick="document.getElementById('addDebtModal').classList.add('active')">
                    <i class="fas fa-plus-circle"></i> <span>Agregar Pr√©stamo</span>
                </div>
            </div>

            <div class="dashboard">
                <div class="section-title">
                    <span>Resumen de Deudas</span>
                    <span id="currentMonth" style="font-size: 16px; color: #666;"></span>
                </div>

                <div class="stats-cards">
                    <div class="stat-card total">
                        <h3>Total Deudas</h3>
                        <div class="stat-value" id="totalDebt">S/ 0.00</div>
                        <div id="totalCount">0 deudas</div>
                    </div>
                    <div class="stat-card pending">
                        <h3>Pendientes</h3>
                        <div class="stat-value" id="pendingDebt">S/ 0.00</div>
                        <div id="pendingCount">0 deudas</div>
                    </div>
                    <div class="stat-card overdue">
                        <h3>Vencidas</h3>
                        <div class="stat-value" id="overdueDebt">S/ 0.00</div>
                        <div id="overdueCountStats">0 deudas</div>
                    </div>
                    <div class="stat-card paid">
                        <h3>Pagadas</h3>
                        <div class="stat-value" id="paidDebt">S/ 0.00</div>
                        <div id="paidCount">0 deudas</div>
                    </div>
                </div>

                <div id="debtList" class="debt-cards"></div>
            </div>
        </div>
    </div>

    <script src="frontend_api_integration.js"></script>
    <script>
        let allDebts = [];

        document.addEventListener('DOMContentLoaded', async () => {
            if (!window.api || !window.api.isAuthenticated()) {
                window.location.href = 'login.html';
                return;
            }
            
            const user = window.api.getCurrentUser();
            if(user) {
                document.querySelector('.welcome').textContent = `¬°Hola, ${user.name}! üëã`;
                document.querySelector('.user-avatar').textContent = user.name.charAt(0).toUpperCase();
            }
            
            const months = ['Enero','Febrero','Marzo','Abril','Mayo','Junio','Julio','Agosto','Septiembre','Octubre','Noviembre','Diciembre'];
            const now = new Date();
            document.getElementById('currentMonth').textContent = `${months[now.getMonth()]} ${now.getFullYear()}`;

            await loadData();
        });

        async function loadData() {
            try {
                const stats = await window.api.getStatistics();
                
                document.getElementById('totalDebt').textContent = formatMoney(stats.total_amount);
                document.getElementById('pendingDebt').textContent = formatMoney(stats.pending_amount);
                document.getElementById('overdueDebt').textContent = formatMoney(stats.overdue_amount);
                document.getElementById('paidDebt').textContent = formatMoney(stats.paid_amount);
                
                document.getElementById('totalCount').textContent = `${stats.total_debts || 0} deudas`;
                document.getElementById('pendingCount').textContent = `${stats.pending_count || 0} deudas`;
                document.getElementById('overdueCountStats').textContent = `${stats.overdue_count || 0} deudas`;
                document.getElementById('paidCount').textContent = `${stats.paid_count || 0} deudas`;
                
                const overdueBadge = document.getElementById('overdueCount');
                overdueBadge.textContent = stats.overdue_count || 0;
                overdueBadge.style.display = stats.overdue_count > 0 ? 'inline-block' : 'none';

                const pendingBadge = document.getElementById('pendingCountBadge');
                pendingBadge.textContent = stats.pending_count || 0;
                pendingBadge.style.display = stats.pending_count > 0 ? 'inline-block' : 'none';

                const debtsData = await window.api.getAllDebts();
                
                allDebts = debtsData.map(d => ({
                    id: d.id,
                    bank: d.bank_name,
                    description: d.description,
                    amount: Number(d.amount),
                    paid: Number(d.paid_amount),
                    remaining: Number(d.amount) - Number(d.paid_amount),
                    date: d.due_date,
                    status: d.status,
                    urgency: d.urgency
                }));
                
                if(document.querySelector('.nav-item.active').innerText.includes('Pendientes')) {
                    filterDebts('pending');
                } else if(document.querySelector('.nav-item.active').innerText.includes('Vencidas')) {
                    filterDebts('overdue');
                } else {
                    renderDebts(allDebts);
                }

            } catch (error) {
                console.error("Error al cargar datos:", error);
                if (error.message && (error.message.includes('sesi√≥n') || error.message.includes('token'))) {
                    window.location.href = 'login.html';
                }
            }
        }

        function renderDebts(debts) {
            const container = document.getElementById('debtList');
            container.innerHTML = '';
            
            if (!debts || debts.length === 0) {
                container.innerHTML = '<p style="grid-column:1/-1; text-align:center; padding: 40px; color:#666;">No tienes deudas en esta categor√≠a.</p>';
                return;
            }

            debts.forEach(d => {
                let cardClass = 'debt-card';
                let dateClass = 'due-date';
                let statusText = d.status;

                // L√ìGICA MODIFICADA PARA UNIFICAR COLORES
                if (d.status === 'paid') {
                    // Pagadas = VERDE
                    cardClass += ' paid';
                    dateClass += ' paid';
                    statusText = 'Pagada';
                } else if (d.status === 'overdue' || d.urgency === 'overdue') {
                    // Vencidas = ROJO
                    cardClass += ' due-today';
                    dateClass += ' due-today';
                    statusText = 'Vencida';
                } else {
                    // Todo lo dem√°s (Pendientes y Pr√≥ximas) = AMARILLO
                    // Se elimina la distinci√≥n de "Pr√≥xima" y "Normal"
                    cardClass += ' due-week';
                    dateClass += ' due-week';
                    statusText = 'Pendiente';
                }

                const fechaVencimiento = d.date ? d.date.split('T')[0] : 'N/A';

                container.innerHTML += `
                    <div class="${cardClass}">
                        <div class="debt-header">
                            <div class="debt-info">
                                <h3>${d.description}</h3>
                                <small style="color:#666"><i class="fas fa-university"></i> ${d.bank}</small>
                            </div>
                            <div class="debt-amount">${formatMoney(d.remaining)}</div>
                        </div>
                        
                        <div class="debt-details">
                            <div class="detail-item">
                                <span class="detail-label">Total Original</span>
                                <span class="detail-value">${formatMoney(d.amount)}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">Estado</span>
                                <span class="detail-value" style="text-transform:capitalize; font-weight:bold;">${statusText}</span>
                            </div>
                        </div>

                        <div class="${dateClass}">
                            <i class="fas fa-calendar"></i> Vence: ${fechaVencimiento}
                        </div>

                        ${d.status !== 'paid' ? `
                            <div class="payment-methods">
                                <button class="payment-btn credit" onclick="openPayModal(${d.id}, ${d.remaining})">
                                    Pagar Ahora
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
        }

        // --- L√ìGICA DE REGISTRO DE DEUDAS Y CUOTAS ---
        
        function toggleInstallments() {
            const freq = document.getElementById('paymentFrequency').value;
            const group = document.getElementById('installmentsGroup');
            if (freq === 'unico') {
                group.style.display = 'none';
            } else {
                group.style.display = 'block';
            }
        }

        async function saveDebt(e) {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'Generando...';
                btn.disabled = true;

                const frequency = document.getElementById('paymentFrequency').value;
                let installments = 1;

                if (frequency !== 'unico') {
                    installments = parseInt(document.getElementById('installments').value) || 12;
                }

                await window.api.createDebt({
                    bank_name: document.getElementById('bankName').value,
                    description: document.getElementById('debtDescription').value,
                    amount: document.getElementById('debtAmount').value,
                    due_date: document.getElementById('dueDate').value,
                    frequency: frequency,
                    installments: installments
                });
                
                closeModal();
                e.target.reset();
                toggleInstallments();
                await loadData();
                alert(`¬°√âxito! Se han generado ${installments} cuotas correctamente.`);
                
            } catch(err) {
                alert("Error al guardar: " + err.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // --- FIN L√ìGICA DE REGISTRO ---

        function openPayModal(id, amount) {
            document.getElementById('payDebtId').value = id;
            document.getElementById('payAmount').value = amount;
            
            const hoyPeru = new Date().toLocaleDateString('en-CA');
            document.getElementById('payDate').value = hoyPeru;
            
            document.getElementById('paymentModal').classList.add('active');
        }

        async function submitPayment() {
            console.log("Iniciando proceso de pago...");
            const btn = document.querySelector('#paymentModal .payment-btn') || document.querySelector('#paymentModal .btn-primary');
            
            if (!btn) {
                alert("Error: No se encontr√≥ el bot√≥n de pago en el c√≥digo.");
                return;
            }

            const originalText = btn.innerHTML;

            try {
                const debtId = document.getElementById('payDebtId').value;
                const amount = document.getElementById('payAmount').value;
                const date = document.getElementById('payDate').value;
                
                const cardNum = document.getElementById('cardNumber').value;
                const cardExp = document.getElementById('cardExp').value;
                const cardCvv = document.getElementById('cardCvv').value;

                if(!amount || amount <= 0) {
                    alert("‚ö†Ô∏è Por favor ingresa un monto v√°lido mayor a 0.");
                    return;
                }
                if(!cardNum || !cardExp || !cardCvv) {
                    alert("‚ö†Ô∏è Faltan datos de la tarjeta. Ll√©nalos todos.");
                    return;
                }

                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
                btn.disabled = true;

                const response = await window.api.createPayment({
                    debt_id: debtId,
                    amount: amount,
                    payment_date: date,
                    cardNumber: cardNum,
                    cardExp: cardExp,
                    cardCvv: cardCvv
                });

                console.log("Respuesta del banco:", response);
                closeModal();
                await loadData();
                
                alert(`‚úÖ ¬°PAGO APROBADO!\n\nüí≥ Tarjeta: **** ${cardNum.slice(-4)}\nüí∞ Monto: S/ ${amount}\nüÜî Operaci√≥n: ${response.transaction_id}`);

            } catch(err) {
                console.error("Error en pago:", err);
                alert("‚ùå Error del Banco:\n" + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function formatMoney(n) {
            return `S/ ${Number(n || 0).toLocaleString('es-PE', {minimumFractionDigits: 2})}`;
        }

        function filterDebts(type, evt) {
            const navItems = document.querySelectorAll('.nav-item');
            navItems.forEach(el => el.classList.remove('active'));

            const target = evt?.currentTarget || document.querySelector(`.nav-item[data-filter="${type}"]`) || navItems[0];
            if (target) {
                target.classList.add('active');
            }
            
            if (type === 'all') {
                renderDebts(allDebts);
            } else if (type === 'pending') {
                const filtered = allDebts.filter(d => d.status === 'pending');
                renderDebts(filtered);
            } else if (type === 'overdue') {
                const filtered = allDebts.filter(d => d.status === 'overdue' || d.urgency === 'overdue');
                renderDebts(filtered);
            } else {
                renderDebts(allDebts);
            }
        }

        function showAddDebtModal() {
            document.getElementById('addDebtModal').classList.add('active');
        }

        function closeModal() {
            document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
        }
    </script>
</body>
</html>